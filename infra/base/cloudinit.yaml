#cloud-config
version: v1
package-update: true
package_upgrade: true
packages:
  - jq
write_files:
  - path: /etc/environment
    content: |
      STEP_CA_VERSION="[STEP_CA_VERSION]"
      STEP_CLI_VERSION="[STEP_CLI_VERSION]"
      AZURE_CLIENT_ID=[AZURE_CLIENT_ID]
    append: true
  - path: /etc/[caVMAdminUsername]/profile
    content: |
      echo "CA init and setup Scripts are present in /opt/stepcainstall"
    append: true
  - path: /opt/stepcainstall/downloadstep.sh
    content: |
      wget https://dl.step.sm/gh-release/cli/docs-ca-install/v[STEP_CLI_VERSION]/step-cli_[STEP_CLI_VERSION]_amd64.deb
      sudo dpkg -i step-cli_[STEP_CLI_VERSION]_amd64.deb
      rm -f step-cli_[STEP_CLI_VERSION]_amd64.deb
      wget https://dl.step.sm/gh-release/certificates/docs-ca-install/v[STEP_CA_VERSION]/step-ca_[STEP_CA_VERSION]_amd64.deb
      sudo dpkg -i step-ca_[STEP_CA_VERSION]_amd64.deb
      rm -f step-ca_[STEP_CA_VERSION]_amd64.deb
    permissions: "0777"
  - path: /opt/stepcainstall/initstepca.sh
    content: |
      echo "Root key URI: azurekms:name=[CA_ROOT_KEY_NAME];vault=[CA_KEYVAULTNAME]"
      echo "Intermediate key URI: azurekms:name=[CA_INT_KEY_NAME];vault=[CA_KEYVAULTNAME]"
      [STEP_CA_INIT_COMMAND]
    permissions: "0777"
  - path: /opt/stepcainstall/setupdaemon.sh
    content: |
      echo "Hello World!"
    permissions: "0777"
runcmd:
  - [
      "wget",
      "-nv",
      "https://dl.step.sm/gh-release/cli/docs-ca-install/v[STEP_CLI_VERSION]/step-cli_[STEP_CLI_VERSION]_amd64.deb",
    ]
  - ["dpkg", "-i", "step-cli_[STEP_CLI_VERSION]_amd64.deb"]
  - [
      "wget",
      "-nv",
      "https://dl.step.sm/gh-release/certificates/docs-ca-install/v[STEP_CA_VERSION]/step-ca_[STEP_CA_VERSION]_amd64.deb",
    ]
  - ["dpkg", "-i", "step-ca_[STEP_CA_VERSION]_amd64.deb"]
